name: Create Release with Artifacts

on:
  push:
    branches: [ main ]

jobs:
  build-and-release:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed to count previous releases

      - name: Build Docker image
        run: docker build -t ff-extractor --secret id=SSH_PRIVATE_KEY --secret id=SSH_PASSPHRASE .
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}

      - name: Copy artifacts from container
        run: |
          container_id=$(docker create ff-extractor)
          docker cp $container_id:/app/artifacts ./artifacts
          docker rm $container_id

      - name: Check changelog and prepare release
        id: prepare_release
        run: |
          # Check if changelog exists and has content
          if [ ! -f "artifacts/changelog.txt" ] || [ ! -s "artifacts/changelog.txt" ]; then
            echo "skip_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get changelog content
          changelog=$(cat artifacts/changelog.txt)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Count previous releases (excluding drafts and pre-releases)
          release_number=$(gh release list --exclude-drafts --exclude-pre-releases | wc -l)
          release_number=$((release_number + 1))
          echo "release_number=$release_number" >> $GITHUB_OUTPUT

          # Format current date
          formatted_date=$(date '+%B %d, %Y %H:%M')
          echo "formatted_date=$formatted_date" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        if: steps.prepare_release.outputs.skip_release != 'true'
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.prepare_release.outputs.release_number }} (${{ steps.prepare_release.outputs.formatted_date }})
          body: |
            Created on ${{ steps.prepare_release.outputs.formatted_date }}.

            Changelog:
            ${{ steps.prepare_release.outputs.changelog }}
          files: artifacts/*.zip
          tag_name: release-${{ steps.prepare_release.outputs.release_number }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upload-csv-files:
    needs: build-and-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed to count previous releases

      - name: Build Docker image for uploading CSV files
        # This is kept as a separate step to avoid breaking releases
        # It also checks if release went alright and files are downloadable
        # This will always use whatever's in the latest release, so you can't mess it up, even when ran locally
        # In the event that you or this script does mess it up, or you want to add a new Google Sheets file, do these:
        # 1. Delete the Google Spreadsheet file if it exists (or delete the worksheets that this script generated in it,
        #    in which case you don't have to delete and re-create the spreadsheet itself, you can just delete the
        #    worksheets that are faulty).
        # 2. Make sure that the only other worksheet(s) in the Spreadsheet are the ones that this script generated
        #    OR ones that are named the same as the spreadsheet.
        # 3. Go to the Google Drive folder and make an unnamed spreadsheet. Then, import the sample CSV file into it,
        #    make sure that the Spreadsheet name and the worksheet name are the same.
        # 4. Run this action or script again. The script checks per build and per file what it can update.
        run: docker build -t ff-extractor-upload-csv -f Dockerfile.upload_csv --secret id=GOOGLE_SERVICE_ACCOUNT_JSON .
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
